{"code":"import * as tslib_1 from \"tslib\";\r\nimport http from 'http';\r\nimport https from 'https';\r\nimport fs from 'fs';\r\nimport onExit from 'async-exit-hook';\r\nimport RequestHandler from './request-handler';\r\nimport Summary from './summary';\r\nimport TapeStoreManager from './tape-store-manager';\r\nimport { parseUrl } from './utils/url';\r\nexport default class TalkbackServer {\r\n    // private closeHandler:\r\n    constructor(options) {\r\n        this.options = options;\r\n        this.tapeStoreManager = new TapeStoreManager(this.options);\r\n        this.handleRequest = this.handleRequest.bind(this);\r\n        this.server = this.createServer(this.handleRequest);\r\n    }\r\n    createServer(requestListener) {\r\n        if (this.options.https) {\r\n            const httpsOpts = {\r\n                key: fs.readFileSync(this.options.https.keyPath),\r\n                cert: fs.readFileSync(this.options.https.certPath),\r\n            };\r\n            return https.createServer(httpsOpts, requestListener);\r\n        }\r\n        return http.createServer(requestListener);\r\n    }\r\n    handleRequest(req, res) {\r\n        const reqBodyChunks = [];\r\n        req\r\n            .on('data', (chunk) => {\r\n            reqBodyChunks.push(chunk);\r\n        })\r\n            .on('end', () => tslib_1.__awaiter(this, void 0, void 0, function* () {\r\n            try {\r\n                const request = req;\r\n                request.body = Buffer.concat(reqBodyChunks);\r\n                const requestHandler = new RequestHandler(this.tapeStoreManager, this.options);\r\n                const fRes = yield requestHandler.handle(request);\r\n                res.writeHead(fRes.status, fRes.headers);\r\n                res.end(fRes.body);\r\n            }\r\n            catch (error) {\r\n                this.options.logger.error('Error handling request');\r\n                this.options.logger.error(error);\r\n                res.statusCode = 500;\r\n                res.end();\r\n            }\r\n        }));\r\n    }\r\n    start(callback) {\r\n        this.options.logger.log(`Starting talkback on ${this.options.talkbackUrl}`);\r\n        const url = parseUrl(this.options.talkbackUrl);\r\n        const promise = new Promise((resolve) => {\r\n            this.server.listen(url, () => {\r\n                if (callback)\r\n                    callback();\r\n                resolve(this.server);\r\n            });\r\n        });\r\n        onExit(() => this.close());\r\n        return promise;\r\n    }\r\n    hasTapeBeenUsed(tapeName) {\r\n        return this.tapeStoreManager.hasTapeBeenUsed(tapeName);\r\n    }\r\n    resetTapeUsage() {\r\n        this.tapeStoreManager.resetTapeUsage();\r\n    }\r\n    close(callback) {\r\n        this.server.close(callback);\r\n        process.removeListener('exit', this.close);\r\n        process.removeListener('SIGINT', this.close);\r\n        process.removeListener('SIGTERM', this.close);\r\n        if (this.options.summary) {\r\n            const summary = new Summary(this.tapeStoreManager.getAllTapes(), this.options);\r\n            summary.print();\r\n        }\r\n    }\r\n}\r\n//# sourceMappingURL=server.js.map","map":"{\"version\":3,\"file\":\"server.js\",\"sourceRoot\":\"\",\"sources\":[\"../../src/server.ts\"],\"names\":[],\"mappings\":\";AAAA,OAAO,IAAgF,MAAM,MAAM,CAAC;AACpG,OAAO,KAAgC,MAAM,OAAO,CAAC;AACrD,OAAO,EAAE,MAAM,IAAI,CAAC;AACpB,OAAO,MAAM,MAAM,iBAAiB,CAAC;AACrC,OAAO,cAAc,MAAM,mBAAmB,CAAC;AAC/C,OAAO,OAAO,MAAM,WAAW,CAAC;AAChC,OAAO,gBAAgB,MAAM,sBAAsB,CAAC;AACpD,OAAO,EAAE,QAAQ,EAAE,MAAM,aAAa,CAAC;AAMvC,MAAM,CAAC,OAAO,OAAO,cAAc;IAIjC,wBAAwB;IAExB,YAAY,OAAgB;QAC1B,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QACvB,IAAI,CAAC,gBAAgB,GAAG,IAAI,gBAAgB,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAC3D,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACnD,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC;IACtD,CAAC;IAED,YAAY,CAAC,eAAgC;QAC3C,IAAI,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE;YACtB,MAAM,SAAS,GAAG;gBAChB,GAAG,EAAE,EAAE,CAAC,YAAY,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,OAAO,CAAC;gBAChD,IAAI,EAAE,EAAE,CAAC,YAAY,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,QAAQ,CAAC;aACnD,CAAC;YAEF,OAAO,KAAK,CAAC,YAAY,CAAC,SAAS,EAAE,eAAe,CAAC,CAAC;SACvD;QAED,OAAO,IAAI,CAAC,YAAY,CAAC,eAAe,CAAC,CAAC;IAC5C,CAAC;IAED,aAAa,CAAC,GAAoB,EAAE,GAAmB;QACrD,MAAM,aAAa,GAAa,EAAE,CAAC;QAEnC,GAAG;aACA,EAAE,CAAC,MAAM,EAAE,CAAC,KAAK,EAAE,EAAE;YACpB,aAAa,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAC5B,CAAC,CAAC;aACD,EAAE,CAAC,KAAK,EAAE,GAAS,EAAE;YACpB,IAAI;gBACF,MAAM,OAAO,GAAG,GAAc,CAAC;gBAE/B,OAAO,CAAC,IAAI,GAAG,MAAM,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC;gBAC5C,MAAM,cAAc,GAAG,IAAI,cAAc,CAAC,IAAI,CAAC,gBAAgB,EAAE,IAAI,CAAC,OAAO,CAAC,CAAC;gBAC/E,MAAM,IAAI,GAAG,MAAM,cAAc,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;gBAElD,GAAG,CAAC,SAAS,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,OAAO,CAAC,CAAC;gBACzC,GAAG,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;aACpB;YAAC,OAAO,KAAK,EAAE;gBACd,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,KAAK,CAAC,wBAAwB,CAAC,CAAC;gBACpD,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;gBACjC,GAAG,CAAC,UAAU,GAAG,GAAG,CAAC;gBACrB,GAAG,CAAC,GAAG,EAAE,CAAC;aACX;QACH,CAAC,CAAA,CAAC,CAAC;IACP,CAAC;IAED,KAAK,CAAC,QAAoB;QACxB,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,GAAG,CAAC,wBAAwB,IAAI,CAAC,OAAO,CAAC,WAAW,EAAE,CAAC,CAAC;QAC5E,MAAM,GAAG,GAAG,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;QAC/C,MAAM,OAAO,GAAG,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE;YACtC,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,GAAG,EAAE,GAAG,EAAE;gBAC3B,IAAI,QAAQ;oBAAE,QAAQ,EAAE,CAAC;gBACzB,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;YACvB,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,MAAM,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,KAAK,EAAE,CAAC,CAAC;QAE3B,OAAO,OAAO,CAAC;IACjB,CAAC;IAED,eAAe,CAAC,QAAgB;QAC9B,OAAO,IAAI,CAAC,gBAAgB,CAAC,eAAe,CAAC,QAAQ,CAAC,CAAC;IACzD,CAAC;IAED,cAAc;QACZ,IAAI,CAAC,gBAAgB,CAAC,cAAc,EAAE,CAAC;IACzC,CAAC;IAED,KAAK,CAAC,QAAqB;QACzB,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC;QAE5B,OAAO,CAAC,cAAc,CAAC,MAAM,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC;QAC3C,OAAO,CAAC,cAAc,CAAC,QAAQ,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC;QAC7C,OAAO,CAAC,cAAc,CAAC,SAAS,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC;QAE9C,IAAI,IAAI,CAAC,OAAO,CAAC,OAAO,EAAE;YACxB,MAAM,OAAO,GAAG,IAAI,OAAO,CAAC,IAAI,CAAC,gBAAgB,CAAC,WAAW,EAAE,EAAE,IAAI,CAAC,OAAO,CAAC,CAAC;YAE/E,OAAO,CAAC,KAAK,EAAE,CAAC;SACjB;IACH,CAAC;CACF\"}"}
